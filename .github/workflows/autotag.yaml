name: create tag
on:
  pull_request:
    types:
      - labeled
      - closed

jobs:
  tag:
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}
          fetch-depth: "0"
      - name: create tag
        if: contains(join(github.event.pull_request.labels.*.name, ';'), 'bump:')
        env:
          LABELS: ${{ join(github.event.pull_request.labels.*.name, ';') }}
        run: |
          curl -LO https://raw.githubusercontent.com/fsaintjacques/semver-tool/master/src/semver
          chmod +x ./semver
          bump=patch
          for lbl in $(echo $LABELS | tr ";" "\n"); do if [[ "$lbl" == "bump:"* ]]; then bump=${lbl/bump:}; fi; done
          echo "bumping to next ${bump} version"
          curVer=$(git tag --sort=-v:refname | head -n1)
          echo "current version: ${curVer}"
          newVer="v$(./semver bump ${bump} $curVer)"
          echo "new version: ${newVer}"
          git config user.name "github-actions"
          git config user.email "ahoy@syn.tools"
          git tag -a -m "${newVer}" "${newVer}"
          git push origin "${newVer}"
  tag-check:
    if: github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: "0"
      # Bump version on merging Pull Requests with specific labels.
      # (bump:major,bump:minor,bump:patch)
      - name: render new tag
        if: contains(join(github.event.pull_request.labels.*.name, ';'), 'bump:')
        env:
          LABELS: ${{ join(github.event.pull_request.labels.*.name, ';') }}
        run: |
          curl -LO https://raw.githubusercontent.com/fsaintjacques/semver-tool/master/src/semver
          chmod +x ./semver
          bump="patch"
          echo $LABELS
          for lbl in $(echo $LABELS | tr ";" "\n"); do if [[ "$lbl" == "bump:"* ]]; then bump=${lbl/bump:}; fi; done
          echo "bumping to next ${bump} version"
          curVer=$(git tag --sort=-v:refname | head -n1)
          echo "current version: ${curVer}"
          newVer="v$(./semver bump ${bump} $curVer)"
          echo "new version: ${newVer}"
          echo "${curVer} -> ${newVer}"
          git config user.name "github-actions"
          git config user.email "ahoy@syn.tools"
          git tag -a -m "${newVer}" "${newVer}"
